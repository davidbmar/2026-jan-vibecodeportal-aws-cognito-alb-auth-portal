# Instance Whitelisting Issue Analysis

## Situation Summary

**What Happened:**
- User (only in ADMINS group) created a new EC2 instance
- Instance was named "marketing"
- When viewing EC2 Resources page, instance shows as "whitelisted for my IP"

**Expected Behavior:**
- User in ADMINS group only should NOT get IP whitelisted on "marketing" instance
- IP whitelisting should only happen when user's group matches the instance's VibeCodeArea tag

---

## Step-by-Step Flow Analysis

### Step 1: Instance Creation

**What You Did:**
- Clicked "Launch Instance" on EC2 Resources page
- Selected area: "marketing"
- Created instance

**What Happened in Code:**
```
File: user_data.sh:385-490 (launch_ec2_instance function)

1. Instance launched with these tags:
   - Name: <auto-generated>
   - VibeCodeArea: "marketing"  ‚Üê This is the key tag
   - LaunchedBy: "vibecode-portal"
   - LaunchDate: <timestamp>

2. Security group attached: "vibecode-launched-instances"
   - SSH (port 22): Only from portal IP (10.0.x.x)
   - HTTP (port 80): NO DEFAULT RULES
   - HTTPS (port 443): NO DEFAULT RULES
```

**Result:** Instance created successfully, tagged with "marketing"

---

### Step 2: IP Whitelisting Logic (During Login)

**When It Happens:**
- Every time you successfully log in
- Code location: user_data.sh:1474

**The Process:**
```python
# After successful login:
user_groups = ['admins']  # Your groups

# Call whitelist function:
whitelist_user_ip_on_instances(email, ['admins'], client_ip)
  ‚Üì
# Inside whitelist function (line 1022-1129):
# Step 1: Get instances for user groups
instances = get_instances_for_user_groups(['admins'])
  ‚Üì
# Inside get_instances_for_user_groups (line 989-1019):
# Filter out system groups
SYSTEM_GROUPS = ['admins']  ‚Üê Defined at line 518
area_groups = [g for g in ['admins'] if g not in SYSTEM_GROUPS]
# Result: area_groups = []  ‚Üê Empty!
  ‚Üì
# For each area group, get matching instances
for area in []:  # Empty list!
    instances = get_instances_by_tag(tag_value=area)
  ‚Üì
# Return empty list
return []
```

**Expected Result:**
- NO instances should be whitelisted
- Your IP should NOT be added to any security groups

---

### Step 3: Viewing EC2 Resources Page

**What You Did:**
- Clicked "EC2 Resources" in navigation

**What Happens:**
```javascript
// Frontend calls:
/api/ec2/instances

// Backend (line 2314-2334):
get_ec2_instances_api()
  ‚Üì
# Get ALL instances with VibeCodeArea tag (regardless of value)
instances = get_instances_by_tag()  # No filter!
  ‚Üì
# For each instance, check if your IP is whitelisted:
for instance in instances:
    instance['port_80_whitelisted'] = check_port_whitelisted(instance_id, 80, client_ip)
    instance['port_443_whitelisted'] = check_port_whitelisted(instance_id, 443, client_ip)
```

**The check_port_whitelisted Function (line 783-825):**
```python
def check_port_whitelisted(instance_id, port, client_ip):
    # Get instance security groups
    # Check all ingress rules for this port
    # Returns TRUE if:
    #   1. Rule exists for 0.0.0.0/0 (open to all), OR
    #   2. Rule exists for your exact IP (e.g., 73.158.64.21/32)
    # Returns FALSE otherwise
```

---

## Why It Shows as "Whitelisted"

Based on the code analysis, there are **4 possible reasons**:

### Scenario 1: Previous Group Membership (Most Likely)

**What Happened:**
1. You were previously added to a "marketing" group (or some other group)
2. You logged in while in that group
3. The login process whitelisted your IP on matching instances
4. You were later removed from the "marketing" group
5. **BUT** - the security group rules were never cleaned up
6. Your IP is still in the security group from before

**Evidence to Check:**
```bash
# Check the marketing instance's security group rules
aws ec2 describe-security-groups \
  --filters Name=group-name,Values=vibecode-launched-instances \
  --region us-west-2 \
  --query 'SecurityGroups[0].IpPermissions[*]' \
  --output json
```

Look for rules with your IP and a description like:
```
"Description": "User=your-email@capsule.com, IP=73.158.64.21, Port=80, Added=2026-01-29T..."
```

---

### Scenario 2: You Have Multiple Groups

**What Happened:**
- You think you're only in ADMINS
- But you might also be in another group (like "marketing")
- When you logged in, the "marketing" group matched the instance

**Evidence to Check:**
```bash
# Check your actual groups
aws cognito-idp admin-list-groups-for-user \
  --user-pool-id us-west-2_WePThH2J8 \
  --username <your-email> \
  --region us-west-2
```

---

### Scenario 3: Security Group Has Open Rule

**What Happened:**
- Someone (or some process) added a 0.0.0.0/0 rule to ports 80/443
- This would make check_port_whitelisted return TRUE for everyone

**Evidence to Check:**
Same command as Scenario 1, but look for:
```json
{
  "CidrIp": "0.0.0.0/0"
}
```

---

### Scenario 4: UI Misinterpretation

**What You Might Be Seeing:**
- The UI shows the instance in the list
- You assume "whitelisted" means you can access it
- But actually, the UI just shows which instances exist

**Check:**
- Look for a specific status indicator (checkmark, green text, etc.)
- Try actually accessing the instance at `http://<instance-ip>`
- If it times out, you're NOT actually whitelisted

---

## How to Diagnose the Issue

### Check 1: What Groups Do You Have?

```bash
aws cognito-idp admin-list-groups-for-user \
  --user-pool-id us-west-2_WePThH2J8 \
  --username <your-email> \
  --region us-west-2
```

**Expected Output:**
```json
{
  "Groups": [
    {"GroupName": "admins", ...}
  ]
}
```

If you see other groups like "marketing", that explains it!

---

### Check 2: What's in the Security Group?

```bash
# Find the marketing instance ID
aws ec2 describe-instances \
  --filters "Name=tag:VibeCodeArea,Values=marketing" \
  --region us-west-2 \
  --query 'Reservations[0].Instances[0].InstanceId' \
  --output text

# Get the security group ID
aws ec2 describe-instances \
  --instance-ids <instance-id> \
  --region us-west-2 \
  --query 'Reservations[0].Instances[0].SecurityGroups[0].GroupId' \
  --output text

# Check the security group rules
aws ec2 describe-security-groups \
  --group-ids <sg-id> \
  --region us-west-2 \
  --output json
```

**Look for:**
```json
{
  "IpPermissions": [
    {
      "FromPort": 80,
      "ToPort": 80,
      "IpProtocol": "tcp",
      "IpRanges": [
        {
          "CidrIp": "YOUR.IP.ADDRESS/32",
          "Description": "User=your-email@capsule.com, IP=YOUR.IP.ADDRESS, Port=80, Added=..."
        }
      ]
    }
  ]
}
```

---

### Check 3: What Does the UI Actually Show?

When you're on the EC2 Resources page:

1. Look for the marketing instance
2. Check the "Port 80" and "Port 443" columns
3. Do they show:
   - ‚úÖ (checkmark) = Whitelisted
   - ‚ùå (X mark) = Not whitelisted
   - üîí or other indicator?

Take a screenshot and share it to confirm what "whitelisted" means in this context.

---

### Check 4: Can You Actually Access It?

```bash
# Get the instance's private IP
aws ec2 describe-instances \
  --filters "Name=tag:VibeCodeArea,Values=marketing" \
  --region us-west-2 \
  --query 'Reservations[0].Instances[0].PrivateIpAddress' \
  --output text

# Try to access it (from your current location)
curl -v http://<private-ip> --connect-timeout 5
```

**If you're NOT whitelisted:**
- Connection will timeout
- "Connection timed out after 5000 milliseconds"

**If you ARE whitelisted:**
- You'll get an HTTP response (even if it's an error page)

---

## The Root Cause

Based on the code logic, **this CANNOT happen** unless:

1. **You were in a matching group before** (most likely)
2. **You're in a matching group now** (check groups)
3. **Security group has open rule** (0.0.0.0/0)
4. **You're misreading the UI** (no actual whitelist)

---

## How the System Should Work

### Correct Behavior:

```
User Groups          Instance VibeCodeArea     Whitelisting
-----------          ---------------------     ------------
['admins']          'marketing'               ‚ùå NO (admins is filtered out)
['admins']          'engineering'             ‚ùå NO (admins is filtered out)
['marketing']       'marketing'               ‚úÖ YES (match!)
['engineering']     'engineering'             ‚úÖ YES (match!)
['admins', 'hr']    'hr'                      ‚úÖ YES (hr matches)
```

### System Groups (Filtered Out):
- `admins` - Administrative group, not an area

### Area Groups (Trigger Whitelisting):
- `engineering`
- `hr`
- `product`
- `automation`
- `marketing` (or any other non-system group)

---

## Recommended Actions

### Action 1: Verify Your Groups

```bash
aws cognito-idp admin-list-groups-for-user \
  --user-pool-id us-west-2_WePThH2J8 \
  --username <your-email> \
  --region us-west-2
```

If you see "marketing" or any group besides "admins", that's why you're whitelisted.

---

### Action 2: Check Security Group Rules

```bash
# Get marketing instance security group rules
aws ec2 describe-instances \
  --filters "Name=tag:VibeCodeArea,Values=marketing" \
  --region us-west-2 \
  --query 'Reservations[0].Instances[0].SecurityGroups[0].GroupId' \
  --output text

# Then:
aws ec2 describe-security-groups --group-ids <sg-id> --region us-west-2
```

Look for your IP in the IpRanges.

---

### Action 3: Clean Up Orphaned Rules (If Found)

If you find your IP in the security group but you're NOT in the marketing group:

```bash
# Remove your IP from port 80
aws ec2 revoke-security-group-ingress \
  --group-id <sg-id> \
  --ip-permissions IpProtocol=tcp,FromPort=80,ToPort=80,IpRanges='[{CidrIp=YOUR.IP.ADDRESS/32}]' \
  --region us-west-2

# Remove your IP from port 443
aws ec2 revoke-security-group-ingress \
  --group-id <sg-id> \
  --ip-permissions IpProtocol=tcp,FromPort=443,ToPort=443,IpRanges='[{CidrIp=YOUR.IP.ADDRESS/32}]' \
  --region us-west-2
```

---

## Code References

| Location | Purpose |
|----------|---------|
| user_data.sh:518 | SYSTEM_GROUPS = ['admins'] |
| user_data.sh:989-1019 | get_instances_for_user_groups() - Filters out system groups |
| user_data.sh:1022-1129 | whitelist_user_ip_on_instances() - Main whitelisting logic |
| user_data.sh:1474 | Whitelisting triggered on login |
| user_data.sh:2314-2334 | API endpoint that checks whitelist status |
| user_data.sh:783-825 | check_port_whitelisted() - Checks if IP is in SG |

---

## Summary

The system is designed so that:
- Users in ADMINS group are NOT whitelisted on any instances
- Users in area groups (engineering, hr, marketing, etc.) ARE whitelisted on matching instances

If you're seeing "whitelisted" on the marketing instance while only in ADMINS, the most likely explanations are:

1. **Stale security group rule** - You were in marketing group before, got whitelisted, then removed from group but IP rule remains
2. **Multiple groups** - You're actually in both ADMINS and marketing groups
3. **UI confusion** - The UI shows the instance exists, but doesn't mean you can access it

**Next Step:** Run the diagnostic commands above to identify which scenario applies.
