{% extends "base.html" %}

{% block title %}MFA SETUP - CAPSULE PORTAL{% endblock %}

{% block content %}
<div class="crt-container">
    <pre class="ascii-art">
  __  __ _____ _
 |  \/  |  ___/ \
 | |\/| | |_ / _ \
 | |  | |  _/ ___ \
 |_|  |_|_|/_/   \_\

 MULTI-FACTOR AUTH
    </pre>

    <div class="content-box">
        <h2>üîê ENABLE MFA FOR {{ email }}</h2>

        <div class="info-section">
            <h3>WHAT IS MFA?</h3>
            <p>Multi-Factor Authentication adds an extra layer of security to your account by requiring a time-based code from your authenticator app in addition to your password.</p>
        </div>

        <!-- Loading state -->
        <div id="loading-state" style="text-align: center; padding: 20px;">
            <p>üîÑ Generating QR code...</p>
        </div>

        <!-- Error state -->
        <div id="error-state" style="display: none; text-align: center; padding: 20px;">
            <p style="color: #ff0000;">‚ùå <span id="error-message">Failed to initialize MFA setup</span></p>
            <button onclick="location.reload()" class="btn-primary">Retry</button>
        </div>

        <!-- MFA Setup Interface -->
        <div id="mfa-setup-interface" style="display: none;">
            <!-- Step 1: Download App -->
            <div class="info-section">
                <h3>STEP 1: INSTALL AUTHENTICATOR APP</h3>
                <p>Download one of these apps on your phone:</p>
                <ul>
                    <li>Google Authenticator</li>
                    <li>Microsoft Authenticator</li>
                    <li>Authy</li>
                </ul>
            </div>

            <!-- Step 2: Scan QR Code -->
            <div class="info-section">
                <h3>STEP 2: SCAN QR CODE</h3>
                <div style="text-align: center; padding: 20px; background: #fff; border-radius: 10px; margin: 20px 0;">
                    <img id="qr-code-image" src="" alt="QR Code" style="max-width: 300px; width: 100%;" />
                </div>
                <p style="text-align: center; color: #00ff00; font-size: 0.9em;">
                    ‚ñº Scan this QR code with your authenticator app ‚ñº
                </p>
            </div>

            <!-- Manual Entry Option -->
            <div class="info-section">
                <h3>CAN'T SCAN? ENTER MANUALLY</h3>
                <p>If you can't scan the QR code, enter this secret key manually in your authenticator app:</p>
                <div style="background: #000; border: 2px solid #00ff00; padding: 15px; margin: 10px 0; text-align: center; font-family: monospace; font-size: 1.2em; letter-spacing: 2px;">
                    <code id="secret-key" style="color: #00ff00;">Loading...</code>
                </div>
                <button onclick="copySecret()" class="btn-secondary" style="margin-top: 10px;">üìã Copy Secret</button>
            </div>

            <!-- Step 3: Verify Code -->
            <div class="info-section">
                <h3>STEP 3: VERIFY CODE</h3>
                <p>Enter the 6-digit code from your authenticator app:</p>

                <div style="margin: 20px 0;">
                    <input
                        type="text"
                        id="verification-code"
                        maxlength="6"
                        placeholder="000000"
                        style="width: 200px; padding: 15px; font-size: 1.5em; text-align: center; font-family: monospace; letter-spacing: 5px; background: #000; color: #00ff00; border: 2px solid #00ff00; border-radius: 5px;"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    />
                </div>

                <button onclick="verifyCode()" class="btn-primary" id="verify-button">
                    ‚úì VERIFY AND ENABLE MFA
                </button>

                <div id="verification-status" style="margin-top: 20px; text-align: center;">
                    <p id="status-message" style="display: none;"></p>
                </div>
            </div>
        </div>

        <!-- Success State -->
        <div id="success-state" style="display: none; text-align: center; padding: 20px;">
            <div style="font-size: 3em; margin: 20px 0;">‚úÖ</div>
            <h3 style="color: #00ff00;">MFA SUCCESSFULLY CONFIGURED!</h3>
            <p>Your account is now protected with Multi-Factor Authentication.</p>
            <p>You'll need to enter a code from your authenticator app each time you log in.</p>
            <div style="margin-top: 30px;">
                <a href="/settings" class="btn-primary">‚Üê RETURN TO SETTINGS</a>
            </div>
        </div>

        <div class="nav-links">
            <a href="/settings">‚Üê BACK TO SETTINGS</a>
        </div>
    </div>
</div>

<style>
    .btn-primary {
        background: #00ff00;
        color: #000;
        padding: 15px 30px;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.1em;
        transition: all 0.3s;
    }

    .btn-primary:hover {
        background: #00cc00;
        transform: scale(1.05);
    }

    .btn-primary:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: #000;
        color: #00ff00;
        padding: 10px 20px;
        border: 2px solid #00ff00;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-secondary:hover {
        background: #00ff00;
        color: #000;
    }

    #verification-code:focus {
        outline: none;
        border-color: #00ff00;
        box-shadow: 0 0 10px #00ff00;
    }
</style>

<script>
    let currentSecret = null;

    // Initialize MFA setup on page load
    async function initializeMFA() {
        try {
            const response = await fetch('/api/mfa/init');
            const data = await response.json();

            if (data.success) {
                // Store secret
                currentSecret = data.secret;

                // Display QR code
                document.getElementById('qr-code-image').src = data.qr_code;

                // Display secret key
                document.getElementById('secret-key').textContent = data.secret;

                // Hide loading, show interface
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('mfa-setup-interface').style.display = 'block';
            } else {
                showError('Failed to generate MFA setup');
            }
        } catch (error) {
            console.error('MFA init error:', error);
            showError('Network error. Please check your connection and try again.');
        }
    }

    // Verify the entered code
    async function verifyCode() {
        const codeInput = document.getElementById('verification-code');
        const code = codeInput.value.trim();
        const statusMsg = document.getElementById('status-message');
        const verifyButton = document.getElementById('verify-button');

        // Validate input
        if (code.length !== 6) {
            statusMsg.textContent = '‚ùå Please enter a 6-digit code';
            statusMsg.style.color = '#ff0000';
            statusMsg.style.display = 'block';
            return;
        }

        // Disable button and show loading
        verifyButton.disabled = true;
        verifyButton.textContent = '‚è≥ Verifying...';
        statusMsg.textContent = 'üîÑ Checking code...';
        statusMsg.style.color = '#ffff00';
        statusMsg.style.display = 'block';

        try {
            const response = await fetch('/api/mfa/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code })
            });

            const data = await response.json();

            if (data.success) {
                // Success! Show success state
                document.getElementById('mfa-setup-interface').style.display = 'none';
                document.getElementById('success-state').style.display = 'block';
            } else {
                // Invalid code
                statusMsg.textContent = '‚ùå ' + (data.error || 'Invalid code. Please try again.');
                statusMsg.style.color = '#ff0000';
                verifyButton.disabled = false;
                verifyButton.textContent = '‚úì VERIFY AND ENABLE MFA';

                // Clear input
                codeInput.value = '';
                codeInput.focus();
            }
        } catch (error) {
            console.error('Verification error:', error);
            statusMsg.textContent = '‚ùå Network error. Please try again.';
            statusMsg.style.color = '#ff0000';
            verifyButton.disabled = false;
            verifyButton.textContent = '‚úì VERIFY AND ENABLE MFA';
        }
    }

    // Copy secret to clipboard
    function copySecret() {
        const secretText = document.getElementById('secret-key').textContent;
        navigator.clipboard.writeText(secretText).then(() => {
            alert('‚úÖ Secret key copied to clipboard!');
        }).catch(err => {
            console.error('Copy failed:', err);
            alert('‚ùå Failed to copy. Please select and copy manually.');
        });
    }

    // Show error state
    function showError(message) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-message').textContent = message;
        document.getElementById('error-state').style.display = 'block';
    }

    // Allow Enter key to verify
    document.addEventListener('DOMContentLoaded', () => {
        initializeMFA();

        document.getElementById('verification-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyCode();
            }
        });
    });
</script>
{% endblock %}
